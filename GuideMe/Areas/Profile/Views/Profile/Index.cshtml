@model AllProfileData

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-xl-11">
            <div class="glass-card overflow-hidden border-0 reveal-1" style="min-height: 700px;">
                <div class="row g-0 h-100">
                    <!-- Left: Profile Image & Identity -->
                    <div class="col-lg-3 p-4 text-center d-flex flex-column align-items-center justify-content-start border-end bg-light bg-opacity-25">
                        <div class="position-relative mb-4 mt-3">
                            <img id="profileImagePreview"
                                 src="~/identity/profile/@Model.ProfileVm.ProfileImage"
                                 alt="Profile"
                                 class="rounded-circle shadow-lg border border-4 border-white"
                                 style="width: 150px; height: 150px; object-fit: cover;">
                            <label for="ProfileImageFile" 
                                   class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 shadow-sm transition-all hover-scale" 
                                   style="cursor:pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 3px solid white;">
                                <i class="bi bi-camera-fill"></i>
                            </label>
                        </div>

                        <h3 class="fw-bold mb-1 text-dark">@Model.ProfileVm.FirstName @Model.ProfileVm.LastName</h3>
                        <p class="text-secondary small mb-3">@Model.ProfileVm.Email</p>
                        
                        <span class="badge-glass mb-4">
                            <i class="bi bi-shield-check-fill me-1"></i>@Model.ProfileVm.Role
                        </span>

                        <form asp-action="ChangePhoto" asp-controller="Profile" asp-area="Profile" method="post" enctype="multipart/form-data" class="w-100">
                            <input type="hidden" name="userId" value="@Model.ProfileVm.Id" />
                            <input type="file" id="ProfileImageFile" name="ProfileImageFile" accept="image/*" class="d-none" onchange="previewProfileImage(event)" />
                            <button type="submit" id="savePhotoBtn" class="btn btn-primary rounded-pill px-4 w-100 shadow-sm d-none transition-all">
                                Update Photo
                            </button>
                        </form>

                        <div class="mt-auto w-100 pt-5">
                            <div class="p-3 rounded-4 bg-white border border-opacity-10 text-start">
                                <small class="text-muted d-block tiny fw-bold text-uppercase mb-2">Account Loyalty</small>
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-patch-check-fill text-primary"></i>
                                    <span class="fw-bold text-dark small">Verified Member</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle: Core Settings -->
                    <div class="col-lg-5 p-4 p-md-5">
                        <form asp-action="UpdateProfile" asp-controller="Profile" asp-area="Profile" method="post">
                            <input type="hidden" asp-for="ProfileVm.Id"/>
                            
                            <h3 class="fw-bold text-dark mb-4 border-start border-4 border-primary ps-3">Personal Identity</h3>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label asp-for="ProfileVm.FirstName" class="form-label tiny fw-bold text-uppercase text-secondary">First Name</label>
                                    <input asp-for="ProfileVm.FirstName" class="form-control rounded-pill px-3" placeholder="First name">
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ProfileVm.LastName" class="form-label tiny fw-bold text-uppercase text-secondary">Last Name</label>
                                    <input asp-for="ProfileVm.LastName" class="form-control rounded-pill px-3" placeholder="Last name">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label asp-for="ProfileVm.PhoneNumber" class="form-label tiny fw-bold text-uppercase text-secondary">Phone Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 rounded-pill-start px-3"><i class="bi bi-phone text-primary"></i></span>
                                    <input asp-for="ProfileVm.PhoneNumber" class="form-control border-start-0 rounded-pill-end px-3" placeholder="e.g. +1 234 567 890">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label asp-for="ProfileVm.Email" class="form-label tiny fw-bold text-uppercase text-secondary">Email Address</label>
                                <input asp-for="ProfileVm.Email" class="form-control rounded-pill px-3" placeholder="Email">
                            </div>

                            <div class="mb-4">
                                <label asp-for="ProfileVm.UserName" class="form-label tiny fw-bold text-uppercase text-secondary">Registry Alias</label>
                                <input asp-for="ProfileVm.UserName" class="form-control rounded-pill px-3" placeholder="Username">
                            </div>

                            <div class="mb-5">
                                <label asp-for="ProfileVm.Country" class="form-label tiny fw-bold text-uppercase text-secondary">Home Country</label>
                                <input asp-for="ProfileVm.Country" class="form-control rounded-pill px-3" placeholder="Country">
                            </div>

                            <div class="text-center pt-2">
                                <button type="submit" class="btn-premium w-100 py-3">Update Global Settings</button>
                            </div>
                        </form>
                    </div>

                    <!-- Right: Specialized Config & Security -->
                    <div class="col-lg-4 p-4 p-md-5 border-start bg-light bg-opacity-10">
                        <h4 class="fw-bold text-dark mb-4">Security & Roles</h4>
                        
                        <div class="accordion accordion-flush" id="profileAccordion">
                            <!-- Role Details -->
                            <div class="accordion-item bg-transparent mb-3 border rounded-4 overflow-hidden shadow-sm">
                                <h2 class="accordion-header">
                                    <button class="accordion-button fw-bold text-dark bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRole">
                                        <i class="bi bi-person-lines-fill me-2 text-primary"></i>@(Model.ProfileVm.Role == UserRole.Guide ? "Guide Credentials" : "Traveler Profile")
                                    </button>
                                </h2>
                                <div id="collapseRole" class="accordion-collapse collapse show" data-bs-parent="#profileAccordion">
                                    <div class="accordion-body bg-white">
                                        @if (Model.ProfileVm.Role == UserRole.Guide)
                                        {
                                            <form asp-action="UpdateGuideDetails" asp-controller="Profile" asp-area="Profile" method="post">
                                                <input type="hidden" name="Id" value="@Model.Guide.Id" />
                                                <div class="mb-3">
                                                    <label class="tiny fw-bold text-uppercase text-muted">License Number</label>
                                                    <input name="LicenseNumber" class="form-control rounded-3" value="@Model.Guide.LicenseNumber">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="tiny fw-bold text-uppercase text-muted">National Identity</label>
                                                    <input name="NationalId" class="form-control rounded-3" value="@Model.Guide.NationalId">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="tiny fw-bold text-uppercase text-muted">Experience (Years)</label>
                                                    <input type="number" name="YearsOfExperience" class="form-control rounded-3" value="@Model.Guide.YearsOfExperience">
                                                </div>
                                                <button type="submit" class="btn btn-outline-primary btn-sm w-100 rounded-pill py-2 fw-bold">Update Credentials</button>
                                            </form>
                                        }
                                        else
                                        {
                                            <form asp-action="UpdateVisitorDetails" asp-controller="Profile" asp-area="Profile" method="post">
                                                <input type="hidden" name="Id" value="@Model.Visitor.Id" />
                                                <div class="mb-3">
                                                    <label class="tiny fw-bold text-uppercase text-muted">Passport Code</label>
                                                    <input name="Passport" class="form-control rounded-3" value="@Model.Visitor.Passport">
                                                </div>
                                                <div class="mb-4">
                                                    <label class="tiny fw-bold text-uppercase text-muted">Availability</label>
                                                    <select class="form-select rounded-3" name="visitorStatus">
                                                        <option value="@VisitorStatus.Available" selected="@(Model.Visitor.visitorStatus == VisitorStatus.Available)">Ready to Travel</option>
                                                        <option value="@VisitorStatus.NotAvailable" selected="@(Model.Visitor.visitorStatus == VisitorStatus.NotAvailable)">On Hiatus</option>
                                                    </select>
                                                </div>
                                                <button type="submit" class="btn btn-outline-primary btn-sm w-100 rounded-pill py-2 fw-bold">Update Details</button>
                                            </form>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Change Password -->
                            <div class="accordion-item bg-transparent border rounded-4 overflow-hidden shadow-sm">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed fw-bold text-dark bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePass">
                                        <i class="bi bi-key-fill me-2 text-primary"></i>Access Protection
                                    </button>
                                </h2>
                                <div id="collapsePass" class="accordion-collapse collapse" data-bs-parent="#profileAccordion">
                                    <div class="accordion-body bg-white">
                                        <form asp-action="ChangePassword" asp-controller="Profile" method="post">
                                            <input type="hidden" name="ApplicationUserId" value="@Model.ProfileVm.Id" />
                                            <div class="mb-3">
                                                <input name="CurrentPassword" type="password" class="form-control rounded-3" placeholder="Current Password">
                                            </div>
                                            <div class="mb-3">
                                                <input name="NewPassword" type="password" class="form-control rounded-3" placeholder="New Secure Password">
                                            </div>
                                            <div class="mb-4">
                                                <input name="ConfirmPassword" type="password" class="form-control rounded-3" placeholder="Confirm Password">
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm w-100 rounded-pill py-2 fw-bold">Change Password</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                       
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <partial name="_NotifactionPartial" />
    <script>
        function previewProfileImage(event) {
            const input = event.target;
            const reader = new FileReader();
            reader.onload = function () {
                const preview = document.getElementById('profileImagePreview');
                preview.src = reader.result;
                document.getElementById('savePhotoBtn').classList.remove('d-none');
            };
            if (input.files && input.files[0]) { reader.readAsDataURL(input.files[0]); }
        }
    </script>
}

<style>
    body { background: #fdfdfd; }
    .tiny { font-size: 0.65rem; letter-spacing: 0.8px; }
    .rounded-pill-start { border-top-left-radius: 2rem !important; border-bottom-left-radius: 2rem !important; }
    .rounded-pill-end { border-top-right-radius: 2rem !important; border-bottom-right-radius: 2rem !important; }
    .hover-scale:hover { transform: scale(1.1); }
    .accordion-button:not(.collapsed) { background-color: #f8f9fa; color: #4f46e5; box-shadow: none; }
    .accordion-button:focus { box-shadow: none; }
    .accordion-item:last-of-type { border-bottom: 1px solid rgba(0,0,0,.125); }
</style>
